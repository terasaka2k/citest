machine:
  parallel: false
dependencies:
  override:
    - ? >-
        set -e;
        function f() {
          echo aaa
          echo bbb >&2
        };
        echo "Installing all dependencies in parallel" \
          & { ( f; ) 2>&1 >.echo_f.log && touch .echo_f_success; } \
          & { ( echo hi; ) 2>&1 >.echo_hi.log && touch .echo_hi_success; } \
          & { ( echo by; ) 2>&1 >.echo_by.log && touch .echo_by_success; } \
          & wait
      : parallel: false

    - ? >-
        set -e;
        if [[ $((0 % $CIRCLE_NODE_TOTAL)) == $CIRCLE_NODE_INDEX ]]; then
          echo $CIRCLE_NODE_INDEX
          echo "Fake install dep1" > dep1
        fi;
        if [[ $((1 % $CIRCLE_NODE_TOTAL)) == $CIRCLE_NODE_INDEX ]]; then
          echo $CIRCLE_NODE_INDEX
          echo "Fake install dep2" > dep2
        fi;
      : parallel: false

    - ls -1a

test:
  override:
    - cat .echo_f.log
    - cat .echo_hi.log
    - cat .echo_by.log
    - cat dep1
    - cat dep2
    - ls -1a

deployment:
  lab:
    branch: lab
    commands:
      - echo "Deploying"
