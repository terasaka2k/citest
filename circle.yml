machine:
  environment:
    HAS_NO_DIFF: 1
    MYCACHE: mycache
dependencies:
  cache_directories:
    - mycache
  pre:
    - rm -f SKIP_DEPS
    - test -d mycache && [ $HAS_NO_DIFF == 1 ] && touch SKIP_DEPS || echo "Has diff"

    - >-
      if [[ ! -f SKIP_DEPS ]]; then
        echo "Removing dependencies cache"
        rm -rf "$MYCACHE" && mkdir "$MYCACHE"
      fi
  override:
    - >-
      if [[ -f SKIP_DEPS ]]; then
        echo "Copying dependencies from cache"
        false
        cp -ra "$MYCACHE"/node_modules .
      else
        echo "Installing dependencies"
        npm i xtend

        echo "Storing dependencies as cache"
        cp -ra node_modules "$MYCACHE"/node_modules
      fi

test:
  override:
    - ls
    - >-
      if [[ -d "$MYCACHE" ]]; then
        ls "$MYCACHE"
      fi
    - /bin/true

deployment:
  lab:
    branch: lab
    commands:
      - echo "Deploying"
